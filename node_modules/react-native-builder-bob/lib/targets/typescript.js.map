{"version":3,"file":"typescript.js","names":["build","root","output","report","options","info","kleur","blue","path","relative","del","project","tsconfig","join","fs","pathExists","config","JSON5","parse","readFile","compilerOptions","conflicts","noEmit","undefined","push","emitDeclarationOnly","declarationDir","outDir","length","warn","reduce","acc","curr","gray","yellow","e","Error","tsc","resolve","platform","which","tsbuildinfo","replace","result","spawn","sync","stdio","status","success","stdout","error","toString","message"],"sources":["../../src/targets/typescript.ts"],"sourcesContent":["import kleur from 'kleur';\nimport path from 'path';\nimport fs from 'fs-extra';\nimport which from 'which';\nimport spawn from 'cross-spawn';\nimport del from 'del';\nimport JSON5 from 'json5';\nimport { platform } from 'os';\nimport type { Input } from '../types';\n\ntype Options = Input & {\n  options?: { project?: string; tsc?: string };\n};\n\nexport default async function build({\n  root,\n  output,\n  report,\n  options,\n}: Options) {\n  report.info(\n    `Cleaning up previous build at ${kleur.blue(path.relative(root, output))}`\n  );\n\n  await del([output]);\n\n  report.info(`Generating type definitions with ${kleur.blue('tsc')}`);\n\n  const project = options?.project ? options.project : 'tsconfig.json';\n  const tsconfig = path.join(root, project);\n\n  try {\n    if (await fs.pathExists(tsconfig)) {\n      try {\n        const config = JSON5.parse(await fs.readFile(tsconfig, 'utf-8'));\n\n        if (config.compilerOptions) {\n          const conflicts: string[] = [];\n\n          if (config.compilerOptions.noEmit !== undefined) {\n            conflicts.push('compilerOptions.noEmit');\n          }\n\n          if (config.compilerOptions.emitDeclarationOnly !== undefined) {\n            conflicts.push('compilerOptions.emitDeclarationOnly');\n          }\n\n          if (config.compilerOptions.declarationDir) {\n            conflicts.push('compilerOptions.declarationDir');\n          }\n\n          if (\n            config.compilerOptions.outDir &&\n            path.join(root, config.compilerOptions.outDir) !== output\n          ) {\n            conflicts.push('compilerOptions.outDir');\n          }\n\n          if (conflicts.length) {\n            report.warn(\n              `Found following options in the config file which can conflict with the CLI options. Please remove them from ${kleur.blue(\n                project\n              )}:${conflicts.reduce(\n                (acc, curr) =>\n                  acc + `\\n${kleur.gray('-')} ${kleur.yellow(curr)}`,\n                ''\n              )}`\n            );\n          }\n        }\n      } catch (e) {\n        report.warn(\n          `Couldn't parse '${project}'. There might be validation errors.`\n        );\n      }\n    } else {\n      throw new Error(\n        `Couldn't find a ${kleur.blue('tsconfig.json')} in the project root.`\n      );\n    }\n\n    let tsc = options?.tsc\n      ? path.resolve(root, options.tsc)\n      : path.resolve(root, 'node_modules', '.bin', 'tsc') +\n        (platform() === 'win32' ? '.cmd' : '');\n\n    if (!(await fs.pathExists(tsc))) {\n      try {\n        tsc = await which('tsc');\n\n        report.warn(\n          `Using a global version of ${kleur.blue(\n            'tsc'\n          )}. Consider adding ${kleur.blue('typescript')} to your ${kleur.blue(\n            'devDependencies'\n          )} or specifying the ${kleur.blue(\n            'tsc'\n          )} option for the typescript target.`\n        );\n      } catch (e) {\n        // Ignore\n      }\n    }\n\n    if (!(await fs.pathExists(tsc))) {\n      throw new Error(\n        `The ${kleur.blue(\n          'tsc'\n        )} binary doesn't seem to be installed under ${kleur.blue(\n          'node_modules'\n        )} or present in $PATH. Make sure you have added ${kleur.blue(\n          'typescript'\n        )} to your ${kleur.blue('devDependencies')} or specify the ${kleur.blue(\n          'tsc'\n        )} option for typescript.`\n      );\n    }\n\n    const tsbuildinfo = path.join(\n      output,\n      project.replace(/\\.json$/, '.tsbuildinfo')\n    );\n\n    try {\n      await del([tsbuildinfo]);\n    } catch (e) {\n      // Ignore\n    }\n\n    const result = spawn.sync(\n      tsc,\n      [\n        '--pretty',\n        '--declaration',\n        '--emitDeclarationOnly',\n        '--project',\n        project,\n        '--outDir',\n        output,\n      ],\n      { stdio: 'inherit' }\n    );\n\n    if (result.status === 0) {\n      await del([tsbuildinfo]);\n\n      report.success(\n        `Wrote definition files to ${kleur.blue(path.relative(root, output))}`\n      );\n    } else {\n      throw new Error('Failed to build definition files.');\n    }\n  } catch (e: any) {\n    if (e.stdout) {\n      report.error(\n        `Errors found when building definition files:\\n${e.stdout.toString()}`\n      );\n    } else {\n      report.error(e.message);\n    }\n\n    throw new Error('Failed to build definition files.');\n  }\n}\n"],"mappings":"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"}