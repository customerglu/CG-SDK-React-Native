{"version":3,"file":"compile.js","names":["compile","root","source","output","babelrc","configFile","modules","copyFlow","report","files","glob","sync","cwd","absolute","nodir","ignore","info","kleur","blue","String","length","path","relative","Promise","all","map","filepath","outputFilename","join","replace","fs","mkdirp","dirname","test","copy","content","readFile","result","babel","transformAsync","sourceMaps","filename","presets","require","resolve","targets","browserslist","findConfig","browsers","node","useBuiltIns","plugins","Error","code","mapFilename","basename","writeFileSync","JSON","stringify","writeFile","success"],"sources":["../../src/utils/compile.ts"],"sourcesContent":["import path from 'path';\nimport fs from 'fs-extra';\nimport kleur from 'kleur';\nimport * as babel from '@babel/core';\nimport browserslist from 'browserslist';\nimport glob from 'glob';\nimport type { Input } from '../types';\n\ntype Options = Input & {\n  babelrc?: boolean | null | undefined;\n  configFile?: string | false | null | undefined;\n  modules: 'commonjs' | false;\n  copyFlow: boolean | undefined;\n};\n\nexport default async function compile({\n  root,\n  source,\n  output,\n  babelrc = false,\n  configFile = false,\n  modules,\n  copyFlow,\n  report,\n}: Options) {\n  const files = glob.sync('**/*', {\n    cwd: source,\n    absolute: true,\n    nodir: true,\n    ignore: '**/{__tests__,__fixtures__,__mocks__}/**',\n  });\n\n  report.info(\n    `Compiling ${kleur.blue(String(files.length))} files in ${kleur.blue(\n      path.relative(root, source)\n    )} with ${kleur.blue('babel')}`\n  );\n\n  await Promise.all(\n    files.map(async (filepath) => {\n      const outputFilename = path\n        .join(output, path.relative(source, filepath))\n        .replace(/\\.(jsx?|tsx?)$/, '.js');\n\n      await fs.mkdirp(path.dirname(outputFilename));\n\n      if (!/\\.(jsx?|tsx?)$/.test(filepath)) {\n        // Copy files which aren't source code\n        fs.copy(filepath, outputFilename);\n        return;\n      }\n\n      const content = await fs.readFile(filepath, 'utf-8');\n      const result = await babel.transformAsync(content, {\n        babelrc: babelrc,\n        configFile: configFile,\n        sourceMaps: true,\n        filename: filepath,\n        ...(babelrc || configFile\n          ? null\n          : {\n              presets: [\n                [\n                  require.resolve('@babel/preset-env'),\n                  {\n                    // @ts-ignore\n                    targets: browserslist.findConfig(root) ?? {\n                      browsers: [\n                        '>1%',\n                        'last 2 chrome versions',\n                        'last 2 edge versions',\n                        'last 2 firefox versions',\n                        'last 2 safari versions',\n                        'not dead',\n                        'not ie <= 11',\n                        'not op_mini all',\n                        'not android <= 4.4',\n                        'not samsung <= 4',\n                      ],\n                      node: '16',\n                    },\n                    useBuiltIns: false,\n                    modules,\n                  },\n                ],\n                require.resolve('@babel/preset-react'),\n                require.resolve('@babel/preset-typescript'),\n                require.resolve('@babel/preset-flow'),\n              ],\n              plugins: [\n                require.resolve('@babel/plugin-proposal-class-properties'),\n              ],\n            }),\n      });\n\n      if (result == null) {\n        throw new Error('Output code was null');\n      }\n\n      let code = result.code;\n\n      if (result.map) {\n        const mapFilename = outputFilename + '.map';\n        code += '\\n//# sourceMappingURL=' + path.basename(mapFilename);\n\n        fs.writeFileSync(mapFilename, JSON.stringify(result.map));\n      }\n\n      await fs.writeFile(outputFilename, code);\n\n      if (copyFlow) {\n        fs.copy(filepath, outputFilename + '.flow');\n      }\n    })\n  );\n\n  report.success(`Wrote files to ${kleur.blue(path.relative(root, output))}`);\n}\n"],"mappings":"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"}